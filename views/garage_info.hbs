<main>
    <div class="container">
        {{#garage}}
        <h2 class="garage-name">Nhà xe {{garageinfo.tennhaxe}}</h2>
        <!-- introduction about the garage -->
        <div id="introduction" class="part">
            <h4 class="title">Giới thiệu</h4>
            <p class="introduction-paragraph">
                {{garageinfo.doangioithieu}}
            </p>
            <div class="introduction-image">
                <img src="{{garageinfo.imagepath}}" alt="Hình ảnh về nhà xe {{garageinfo.tennhaxe}}">
            </div>
        </div>
        <!-- Rating & comment about the garage -->
        <div id="review" class="part pb-1">
            <h4 class="title">Đánh giá</h4>
            <div class="rating d-flex">
                <i class="fa-solid fa-star not-chevron"></i>
                <h4 class="rate">{{garageinfo.sosaoTB}}/5</h4>
                <p class="number-of-ratings">({{num_of_cmts}} lượt đánh giá)</p>
            </div>
        </div>
        <div id="comment-slider" class="carousel slide" data-interval="1000000">
            <div class="carousel-inner" role="listbox">
                {{#each cmts}}
                {{#if (isLessThan3 @index) }}
                <div class="carousel-item">
                    <div class="comments row d-flex justify-content-center">
                        {{#each this}}
                        <div class="comment-item col-md-6 mx-2 mb-4">
                            <div class="d-flex justify-content-between flex-wrap">
                                <div class="d-flex">
                                    <div class="user-avatar">
                                        <img src="/assets/img/user.png" alt="">
                                    </div>
                                    <div class="user-infor">
                                        <p class="date-post">
                                            {{this.ngayDanhGia}}
                                        </p>
                                        <p class="user-name">
                                            {{this.TaiKhoan.hoten}}
                                        </p>
                                    </div>
                                </div>
                                <div class="user-rate">
                                    <p class="type-bus">
                                        Loại xe: <span>{{this.loaiGhe}}</span>
                                    </p>
                                    <p class="star-cmt">
                                        Đánh giá:
                                        {{{generateStar this.soSao}}}
                                    </p>
                                </div>
                            </div>
                            <div class="comment-text">
                                {{this.noiDung}}
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
                {{/each}}
            </div>
            <div class="left carousel-prev-btn" type="button" data-bs-target="#comment-slider" data-bs-slide="prev">
                <div class='nav-btn prev-slide'><i class='fa fa-chevron-left'></i></div>
            </div>
            <div class="right carousel-next-btn" type="button" data-bs-target="#comment-slider" data-bs-slide="next">
                <div class='nav-btn next-slide'><i class='fa fa-chevron-right'></i></div>
            </div>
        </div>

        <div class="view-more position-absolute" onclick="openOverlay()">
            <span class="">Hiển thị thêm <i class="fa-solid fa-circle-chevron-right"></i></span>
        </div>

        <div id="overlay" onclick="closeOverlay()">
            <div class="overlay-block" onclick="blockCloseOverlay()">
                <div class="close-overlay" onclick="closeOverlay()">
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <div class="content-view-more">
                    <h4 id="top-overlay" class="title-overlay">Đánh giá</h4>
                    <div class="rating d-flex">
                        <i class="fa-solid fa-star not-chevron"></i>
                        <h4 class="rate">{{garageinfo.sosaoTB}}/5</h4>
                        <p class="number-of-ratings">({{num_of_cmts}} lượt đánh giá)</p>
                    </div>

                    <div class="add comments row d-flex justify-content-center">
                        {{#each cmts}}
                        {{#each this}}
                        <div class="comment-item col-md-6 mx-2 mb-4">
                            <div class="d-flex justify-content-between flex-wrap">
                                <div class="d-flex">
                                    <div class="user-avatar">
                                        <img src="/assets/img/user.png" alt="">
                                    </div>
                                    <div class="user-infor">
                                        <p class="date-post">
                                            {{this.ngayDanhGia}}
                                        </p>
                                        <p class="user-name">
                                            {{this.TaiKhoan.hoten}}
                                        </p>
                                    </div>
                                </div>
                                <div class="user-rate">
                                    <p class="type-bus">
                                        Loại xe: <span>{{this.loaiGhe}}</span>
                                    </p>
                                    <p class="star-cmt">
                                        Đánh giá:
                                        {{{generateStar this.soSao}}}
                                    </p>
                                </div>
                            </div>
                            <div class="comment-text">
                                {{this.noiDung}}
                            </div>
                        </div>
                        {{/each}}
                        {{/each}}
                    </div>
                    <div id="viewMore" class="float_right" onclick="viewMore()">
                        <span class="">Xem thêm <i class="fa-solid fa-circle-chevron-down"></i></span>
                    </div>
                    <div id="viewLess" class="float_right" onclick="viewLess()">
                        <a href="#top-overlay" class='default-a'><span>Rút gọn <i
                                    class="fa-solid fa-circle-chevron-up"></i></span></a>

                    </div>
                </div>
            </div>
        </div>
        <!-- Contact of the garage -->
        <div id="contact" class="part">
            <h4 class="title">Thông tin liên hệ</h4>
            <div class="d-flex">
                <i class="fa-solid fa-phone not-chevron"></i>
                <p>Số điện thoại:<span> {{garageinfo.sdt}}</span></p>
            </div>
            <div class="d-flex">
                <i class="fa-solid fa-location-dot not-chevron"></i>
                <p>Địa chỉ:<span> {{garageinfo.diachi}}</span></p>
            </div>
            <div class="d-flex">
                <i class="fa-solid fa-envelope not-chevron"></i>
                <p>Email:<span> {{garageinfo.email}}</span></p>
            </div>
            <div class="d-flex">
                <i class="fa-solid fa-laptop not-chevron"></i>
                <p>Website:<span> {{garageinfo.website}}</span></p>
            </div>
        </div>

        <div class="part">
            <h4 class="title">Đánh giá của bạn về chúng tôi:</h4>
            <div class="part add-comment mt-3">
                <form id="add-review" action="/garage_info/addReview" method="POST">
                    <input type="hidden" name="ID_NX" value="{{garageinfo.ID_NX}}">
                    <div class="stars">
                        <input class="star star-5" id="star-5" type="radio" name="star" value="5" />
                        <label class="star star-5" for="star-5"></label>
                        <input class="star star-4" id="star-4" type="radio" name="star" value="3" />
                        <label class="star star-4" for="star-4"></label>
                        <input class="star star-3" id="star-3" type="radio" name="star" value="3" />
                        <label class="star star-3" for="star-3"></label>
                        <input class="star star-2" id="star-2" type="radio" name="star" value="2" />
                        <label class="star star-2" for="star-2"></label>
                        <input class="star star-1" id="star-1" type="radio" name="star" value="1" />
                        <label class="star star-1" for="star-1"></label>
                    </div>
                    <div class="mb-3 d-flex">
                        <label for="loaiGhe">Loại ghế: </label>
                        <input type="text" class="form-control width-input mx-3" name="loaiGhe" id="loaiGhe"
                            data-bs-toggle="dropdown" value="{{loaiGhe.[0].loaiXe}}" required>
                        <ul class="dropdown-menu w-10 text-center overflow-auto">
                            {{#each loaiGhe}}
                            <li class="dropdown-item" onclick="loadDropdown(this)">{{this.loaiXe}}</li>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="mb-3">
                        <label for="noiDung" class="form-label">Nội dung đánh giá:</label>
                        <textarea class="form-control w-75" name="noiDung" id="noiDung" rows="3" required></textarea>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="submit" class="btn btn-primary add-btn">Lưu</button>
                    </div>
                </form>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                <symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                </symbol>
                <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                </symbol>
            </svg>

            <div class="alert alertF alert-danger d-flex align-items-center" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Danger:">
                    <use xlink:href="#exclamation-triangle-fill" />
                </svg>
                <div id="noticeF">
                    My alert
                </div>
            </div>
        </div>
        {{/garage}}




    </div>
    <script type="text/javascript">
        var checkitem = function () {
            var $this;
            $this = $("#comment-slider");
            if ($("#comment-slider .carousel-inner .carousel-item:first").hasClass("active")) {
                $this.children(".left").css("display", "none");
                $this.children(".right").css("display", "");
            } else if ($("#comment-slider .carousel-inner .carousel-item:last").hasClass("active")) {
                $this.children(".right").css("display", "none");
                $this.children(".left").css("display", "");
            } else {
                $this.children(".carousel-prev-btn").css("display", "");
                $this.children(".carousel-next-btn").css("display", "");
            }
        };

        checkitem();

        $("#comment-slider").on("slid.bs.carousel", "", checkitem);
    </script>
    <script>
        const myCarouselElement = document.querySelector('#comment-slider')
        const carousel = new bootstrap.Carousel(myCarouselElement, {
            wrap: false
        })
    </script>

    <script>
        const myAlertF = document.getElementById("noticeF");
        const noticeF = document.getElementsByClassName("alertF");
        function getToday() {
            var today = new Date();
            var DD = String(today.getDate()).padStart(2, '0');
            var MM = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();

            today = yyyy + '/' + MM + '/' + DD;
            return today;
        }
        document.forms['add-review'].addEventListener('submit', (event) => {
            event.preventDefault();
            // TODO do something here to show user that form is being submitted
            let url = {
                method: 'POST',
                body: new URLSearchParams(new FormData(event.target)) // event.target is the form
            }
            if (!localStorage.getItem('accessToken')) {
                myAlertF.innerHTML = "Bạn phải đăng nhập trước khi đánh giá nhà xe này";
                noticeF[0].setAttribute('style', 'visibility: visible !important');
                setTimeout(() => noticeF[0].setAttribute('style', 'visibility: hidden !important'), 3000);
                return
            }
            url.body.set("accessToken", localStorage.getItem('accessToken'));
            url.body.set("refreshToken", localStorage.getItem('refreshToken'));
            url.body.set("ngayDanhGia", getToday());
            fetch(event.target.action, url
            ).then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // or response.text() or whatever the server sends
            }).then((body) => {
                if (body.sign === "0") {
                    myAlertF.innerHTML = body.result;
                    noticeF[0].setAttribute('style', 'visibility: visible !important');
                    setTimeout(() => noticeF[0].setAttribute('style', 'visibility: hidden !important'), 3000);
                }
                else {
                    window.location.hash = '#review';
                    setTimeout(() => window.location.reload(true), 1000);
                }
                // TODO handle body
            }).catch((error) => {
                // TODO handle error
            });
        });

        function loadDropdown(e) {
            e.parentElement.parentElement.children[1].value = e.innerText;
            console.log(e.innerText);
        }
        const number_of_CMT_added = 4;
        var count = number_of_CMT_added * 2;
        const listCMTS = document.getElementsByClassName("add")[0].children;
        window.onload = function () {
            const carousel_inner = document.getElementsByClassName("carousel-inner")[0];
            document.getElementsByClassName("carousel-prev-btn")[0].style.display = "none";
            if (carousel_inner.childElementCount == 0) carousel_inner.innerHTML = "<p style='text-align:center; font-style:italic;'>Hiện tại chưa có comment nào</p>";
            if (carousel_inner.childElementCount == 1) {
                document.getElementsByClassName("carousel-prev-btn")[0].style.display = "none";
                document.getElementsByClassName("carousel-next-btn")[0].style.display = "none";
            }
            if (carousel_inner.childElementCount < 3) {
                document.getElementsByClassName("view-more")[0].style.display = "none";
            }
            const carousel_inner_first = document.getElementsByClassName("carousel-inner")[0].firstElementChild;
            carousel_inner_first.classList.add("active")
            for (let i = number_of_CMT_added; i < listCMTS.length; i++) {
                listCMTS[i].style.display = "none";
            }
        }
        function blockCloseOverlay() {
            event.stopPropagation();
        }
        function openOverlay() {
            document.getElementById("overlay").style.display = "block";
        }
        function closeOverlay() {
            document.getElementById("overlay").style.display = "none";
        }
        function viewMore() {
            document.getElementById("viewLess").style.display = "block";
            if (count >= listCMTS.length) {
                document.getElementById("viewMore").style.display = "none";
            }
            for (let i = 0; i < count; i++) {
                listCMTS[i].style.display = "block";
            }
            count += number_of_CMT_added;
        }
        function addOneElement() {
            var content_block = document.querySelector(".add");

            const new_comment = document.createElement('div')
            new_comment.className = 'comment-item col-md-6 mx-2 mb-4'
            new_comment.innerHTML = '<div class="d-flex justify-content-between flex-wrap"><div class="d-flex"><div class="user-avatar"><img src="/assets/img/user.png" alt=""></div><div class="user-infor"><p class="date-post">04/11/2022</p><p class="user-name">Nguyễn Văn A</p></div></div><div class="user-rate"><p class="type-bus">Loại xe: <span>Ghế ngồi</span></p><p class="star">Đánh giá:<i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></p></div></div><div class="comment-text">Chất lượng nhà xe rất tốt, tài xế nhiệt tình, xe sạch đẹp, đệm êm.</div></div>';
            content_block.appendChild(new_comment)
            console.log(content_block)
        }
        function viewLess() {
            setTimeout(function () {
                document.getElementById("viewLess").style.display = "none";
                document.getElementById("viewMore").style.display = "block";
                for (let i = number_of_CMT_added; i < listCMTS.length; i++) {
                    listCMTS[i].style.display = "none";
                }
                count = number_of_CMT_added * 2;
            }, 500);

        }
    </script>
</main>